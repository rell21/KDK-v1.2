<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Kembaran Digital Kadaster</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>

    

    <style>
    /* Pastikan elemen html dan body memenuhi layar */
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
    #map {
        position: fixed;
        top: 56px; /* Sesuaikan dengan tinggi navbar */
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 5; /* Lebih rendah dari navbar */
    }
    .custom-ruler-control {
            position: absolute;
            bottom: 250px; /* Set posisi vertikal */
            left: 10px; /* Set posisi horizontal */
            z-index: 10; /* Agar berada di atas peta */
    }
    #track-button {
            position: absolute;
            bottom: 40px; /* Posisikan tombol di kiri bawah */
            left: 10px;
            z-index: 10;
            padding: 10px 15px;
            background-color: #08bccc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    #track-button.active {
            background-color: #dc3545;
        }
    #image-ui {
            position: absolute;
            top: 250px; /* Jarak dari atas */
            right: 10px; /* Jarak dari kiri */
            z-index: 999; /* Supaya muncul di atas peta */
            background-color: white;
            border: 2px solid #ccc;
            padding: 5px;
            border-radius: 2px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column; /* Mengatur elemen anak secara vertikal */
            align-items: center;   /* Opsional: untuk meratakan elemen di tengah */
            gap: 10px;
        }
    #image-ui img {
            width: 150px; /* Lebar gambar */
            height: auto; /* Menjaga proporsi */
        }
    #clock {
            position: absolute;
            bottom: 90px; /* Letakkan di bawah */
            left: 10px;   /* Letakkan di kiri */
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.6); /* Transparansi hitam */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }
    .mapboxgl-ctrl-geocoder input[type="text"] {
            text-indent: 20px !important; /* Sesuaikan padding untuk teks di dalamnya */
        }

    .geojson-layer :hover {
            opacity: 2; /* Efek hover */
        }
    
    #menu {
            position: absolute;
            bottom: 10px; /* Pastikan tidak tumpang tindih dengan geocoder */
            left: 800px;
            background: #efefef;
            padding: 10px;
            z-index: 500; /* Z-index lebih rendah dari geocoder */
            font-family: 'Open Sans', sans-serif;
        }
    .control-button {
            position: absolute;
            bottom: 175px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            z-index: 500;
            flex-direction: column; /* Mengubah tombol menjadi menurun */
            align-items: center;
            gap: 10px;
        }
    .control-button button {
            background: none;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    .control-button button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    .control-button button:hover {
            opacity: 0.8; /* Efek hover */
        }
        .history-dropdown {
      position: absolute;
      top: 95px;
      right: 220px; /* Atur sesuai lokasi "Area & Perimeter" */
      font-family: Arial, sans-serif;
      z-index: 1000;
    }

    /* Tombol Dropdown */
    #history-btn {
      background-color: #0dcaf0;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      z-index: 1000;
    }

    #history-btn:hover {
      background-color: #0dcaf0;
    }

    /* Isi Dropdown */
    .dropdown-content {
      display: none;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      position: absolute;
      right: 0; /* Menggeser dropdown ke kiri tombol */
       /* Geser ke kiri sejauh 100% dari lebarnya */
      width: 250px;
      list-style: none;
      margin: 0;
      padding: 10px 0;
      z-index: 1000;
    }

    .dropdown-content li {
      padding: 8px 15px;
      font-size: 14px;
      border-bottom: 1px solid #f1f1f1;
    }

    .dropdown-content li:last-child {
      border-bottom: none;
    }

    .dropdown-content li:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    /* CSS untuk Pop-up */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      width: 400px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    width: 60%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f4f4f4;
    }

    .close-btn {
      background-color: red;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Container untuk tombol dan badge */
    .history-container {
      position: relative;
      display: inline-block; /* Supaya ukuran mengikuti konten */
    }

/* Tombol History */
    .history-btn {
      padding: 8px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    /* Badge notifikasi */
    .notification-badge {
      position: absolute;
      top: -8px; /* Geser ke atas */
      right: -8px; /* Geser ke kanan */
      background-color: red;
      color: white;
      font-size: 12px;
      font-weight: bold;
      border-radius: 50%; /* Membuat bulatan */
      padding: 4px 7px;
      line-height: 1;
      text-align: center;
      min-width: 18px; /* Ukuran minimal agar angka terlihat baik */
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); /* Efek bayangan */
    }

    #history-content {
        display: none;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #history-content li {
        padding: 10px;
        cursor: pointer;
    }

    #history-content li:hover {
        background-color: #f1f1f1;
    }

    .action-btn {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 12px;
    margin-right: 10px;
    cursor: pointer;
    border-radius: 5px;
}

    .action-btn:hover {
        background-color: #218838;
    }


    </style>
    <link rel="stylesheet" href="node_modules/@mapbox-controls/ruler/src/index.css">
    <script src="https://cdn.jsdelivr.net/npm/mapbox-gl-rain-layer@latest/dist/mapbox-gl-rain-layer.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" type="text/css">
    <script src='https://github.com/lukasmartinelli/mapbox-gl-inspect/releases/download/v1.3.1/mapbox-gl-inspect.js'></script>
    <link href='https://github.com/lukasmartinelli/mapbox-gl-inspect/releases/download/v1.3.1/mapbox-gl-inspect.css' rel='stylesheet' />

    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.css" type="text/css">

    <script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-traffic/mapbox-gl-traffic.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-traffic/mapbox-gl-traffic.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>


</head>

<body>

    <!-- Spinner Start -->
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->


    <!-- Navbar Start -->
    <nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
        <a href="index.html" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
            <h2 class="m-0 text-primary"><i class="fa fa-map me-3"></i>Kembaran Digital Kadaster</h2>
        </a>
        <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto p-4 p-lg-0">
                <a href="index.html" class="nav-item nav-link">Beranda</a>
                <a href="about.html" class="nav-item nav-link">Tentang</a>
                <a href="contact.html" class="nav-item nav-link">Kontak</a>
                
            </div>
            <a href="courses.html" class="btn btn-primary py-4 px-lg-5 d-none d-lg-block">Jelajahi<i class="fa fa-arrow-right ms-3"></i></a>
        </div>
    </nav>
    <style>
        .calculation-box {
            height: 120px;
            width: 150px;
            position: absolute;
            top: 85px;
            right: 50px;
            z-index: 10;
            background-color: rgb(255, 255, 255);
            padding: 15px;
            text-align: center;
            border-radius: 10px; /* Adjust this value to control roundness */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Optional: Add shadow for consistency */
        }
    
        p {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            font-size: 13px;
        }
    </style>
    
    </style>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css">
    <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    
    <!-- Navbar End -->
    <div id="map"></div>
    <div id="menu">
        <input id="satellite-streets-v12" type="radio" name="rtoggle" value="satellite" checked="checked">
        <!-- See a list of Mapbox-hosted public styles at -->
        <!-- https://docs.mapbox.com/api/maps/styles/#mapbox-styles -->
        <label for="satellite-streets-v12">satellite streets</label>
        <input id="traffic-day-v2" type="radio" name="rtoggle" value="Traffic Day">
        <label for="traffic-day-v2">Traffic Day</label>
        <input id="traffic-night-v2" type="radio" name="rtoggle" value="Traffic Night">
        <label for="traffic-night-v2">Traffic Night</label>
        <input id="streets-v12" type="radio" name="rtoggle" value="OSM">
        <label for="streets-v12">OSM</label>
    </div>
    <div id="rulerControlContainer" class="custom-ruler-control"></div>

    <div class="history-dropdown">
        <button id="history-btn">Aktivitas ⌄</button>
        <span class="notification-badge">2</span>
        <ul id="history-content" class="dropdown-content">
          <!-- Data transaksi akan dimuat di sini -->
        </ul>
    </div>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>Detail Transaksi</h3>
            <table id="transaction-table" border="1" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Informasi</th>
                        <th>Nilai Lama</th>
                        <th>Nilai Baru</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data akan ditampilkan oleh JavaScript -->
                </tbody>
            </table>
            <div style="margin-top: 10px;">
                <!-- Tombol baru -->
                <button id="fly-to-location" class="action-btn" onclick="changeView(20, 0, 0,  -7.786757, 110.370501)">Lihat Lokasi</button>
                <button class="close-btn" id="close-modal">Tutup</button>
            </div>
        </div>
    </div>
    

    <div class="control-button">
        <button onclick="changeView(15, 0, 0,-7.786487,110.374298)">
            <img src="https://images.vexels.com/content/139243/preview/parallelogram-shape-rounded-corners-02b586.png" alt="View 1" title="Orthoview">
        </button>
        <button onclick="changeView(15, 60, -60,-7.786487,110.374298)">
            <img src="https://static.vecteezy.com/system/resources/previews/048/033/944/non_2x/flying-bird-silhouette-icon-with-simple-and-modern-design-png.png" alt="View 2" title="Bird-Eye View">
        </button>
        <button onclick="changeView(15, 60, 0,-7.786487,110.374298)">
            <img src="https://cdn-icons-png.flaticon.com/512/2618/2618245.png" alt="View 3" title="Reset View">
        </button>
    </div>

    <div id="image-ui">
        <img src="./img/legendafix.png" alt="Image 1" />
    </div>

    <div id="clock"></div> 
    <button id="track-button">Geolocation</button>
    <div class="calculation-box">
        <p>Area & Perimeter</p>
        <div id="calculated-area"></div>
    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicmFmZmlzYXR5YW4iLCJhIjoiY2xhcTg5b3czMWc2bzQxbzJkb3g5ZTIzbSJ9._XfNtiapF6wZ03D0sGo_YQ';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [110.3721521,-7.7815394], // Initial map center
            projection: 'globe',
            zoom: 15,
            pitch: 60,
            bearing: 0,

        });

        map.on('style.load', () => {
        map.setFog({
            color: 'rgb(186, 210, 235)', // Lower atmosphere
            'high-color': 'rgb(36, 92, 223)', // Upper atmosphere
            'horizon-blend': 0.02, // Atmosphere thickness (default 0.2 at low zooms)
            'space-color': 'rgb(11, 11, 25)', // Background color
            'star-intensity': 0.6 // Background star brightness (default 0.35 at low zoooms )
        });
        });

        const routes = [
            [[ 110.367189979968771, -7.782831738228521 ], [ 110.374882986271103, -7.782967243069937 ], [ 110.374878844201703, -7.783002746521836 ], [ 110.367190867555067, -7.78290304099442 ]],
            [[ 110.374913312136172, -7.782971089277224 ], [ 110.376006226730411, -7.776237859624531 ], [ 110.375912142582862, -7.776184604446681 ], [ 110.375838768782273, -7.77607927753938 ], [ 110.375856520508236, -7.775907677521865 ], [ 110.376015102593385, -7.775796433372581 ], [ 110.376164217091358, -7.775813001650134 ], [ 110.376280195034226, -7.775936080283385 ], [ 110.376282561931021, -7.776101763058914 ], [ 110.376194986749667, -7.776201172724233 ], [ 110.376093210187562, -7.776246143763305 ], [ 110.375005621111072, -7.782963396862641 ]],
            [[ 110.375014201111796, -7.782986178244271 ], [ 110.381320797617505, -7.78304061687052 ]],
            [[ 110.373720100289731, -7.788456668457743 ], [ 110.373402936119433, -7.78834424086006 ], [ 110.373252638173071, -7.788138320839044 ], [ 110.373195832650026, -7.787780919423259 ], [ 110.373219501617925, -7.786926469680882 ], [ 110.373814776161467, -7.786855462777084 ], [ 110.374335493456002, -7.786893333125777 ], [ 110.375244381824615, -7.787314640754981 ], [ 110.375286985966866, -7.787411683523506 ], [ 110.375218345959865, -7.787737131832582 ], [ 110.374851476956906, -7.788372643621576 ], [ 110.374662125213433, -7.788505189842001 ], [ 110.374423068637313, -7.788557261571452 ], [ 110.374148508609295, -7.788559628468246 ], [ 110.373720100289731, -7.788456668457743 ], [ 110.375286985966866, -7.787411683523506 ], [ 110.375218345959865, -7.787737131832582 ], [ 110.374851476956906, -7.788372643621576 ], [ 110.374662125213433, -7.788505189842001 ], [ 110.374423068637313, -7.788557261571452 ], [ 110.374148508609295, -7.788559628468246 ], [ 110.373720100289731, -7.788456668457743 ]],
            [[ 110.367042492711548, -7.782690907869306 ], [ 110.36756321000604, -7.778045872912483 ], [ 110.368083927300546, -7.77398427801521 ], [ 110.368107596268445, -7.773402021404061 ], [ 110.368156709376905, -7.773403796576657 ], [ 110.368129490063751, -7.773986644912002 ], [ 110.367092789268312, -7.782686174075717 ]],
            [[ 110.368960270838173, -7.789740709968095 ], [ 110.369227730175808, -7.789569109950582 ], [ 110.369596966075562, -7.789500469943577 ], [ 110.369929515075015, -7.789399876829862 ], [ 110.371604094556218, -7.788201043604064 ], [ 110.372385170498006, -7.787912282195284 ], [ 110.373142577471853, -7.787803404942792 ]],
            [[ 110.373174530578609, -7.787934767714821 ], [ 110.37286979261647, -7.787905773229102 ], [ 110.372343158079971, -7.787997490479841 ], [ 110.371573916622154, -7.788340690514865 ], [ 110.370002297151373, -7.789427096142981 ], [ 110.369780992301216, -7.789535973395474 ], [ 110.369251990867923, -7.789635383060792 ], [ 110.369017668085391, -7.789821184459064 ]],
            [[ 110.374314783108645, -7.776157089271439 ], [ 110.373417729223988, -7.778097944641928 ], [ 110.372324222905505, -7.782874342370773 ]],
            [[ 110.371436636608038, -7.783040025146303 ], [ 110.37125734417593, -7.784184419745853 ], [ 110.372378069807567, -7.786938895889036 ], [ 110.372323631181317, -7.78740280766052 ], [ 110.372331915320089, -7.787857251844829 ]],
            [[ 110.372241381517753, -7.787881512536963 ], [ 110.372218895998216, -7.787359611794044 ], [ 110.37229937048923, -7.786916410369503 ], [ 110.371235154518473, -7.784206017679088 ]],
            [[ 110.371214444171429, -7.784219331473547 ], [ 110.36953039710302, -7.785692724727363 ]],
            [[ 110.369535722620839, -7.785702784038736 ], [ 110.369597853661645, -7.786513446190433 ], [ 110.369737500572441, -7.786956055890777 ], [ 110.370232182002241, -7.787554880779478 ], [ 110.370733964122422, -7.787857843569018 ], [ 110.371406162811709, -7.788070864280413 ], [ 110.371808535266567, -7.788088616006364 ]],
            [[ 110.371471252473526, -7.788267316714253 ], [ 110.371348173840275, -7.78811346842269 ], [ 110.370523310307831, -7.787830624255892 ], [ 110.370080700607488, -7.787506359395213 ], [ 110.369706730914132, -7.786976174513517 ], [ 110.369658801254047, -7.786836527602714 ]],
            [[ 110.374283569656853, -7.786748508628204 ], [ 110.374920264894229, -7.782998160659246 ], [ 110.375004289730384, -7.783013545488402 ], [ 110.374382979322149, -7.786791112770483 ]]
        ];

        const modelAltitude = 0;
        const modelRotate = [Math.PI / 2, 0, 0];

        // Create individual state for each route
        // Update state initialization to include direction
        const states = routes.map(() => ({
            routeIndex: 0,
            progress: 0,
            direction: 1, // 1 means forward, -1 means backward
        }));

        const updateModelPosition = (state, route) => {
            const start = route[state.routeIndex];
            const nextIndex = (state.routeIndex + state.direction + route.length) % route.length;
            const end = route[nextIndex];

            const lng = start[0] + state.progress * (end[0] - start[0]);
            const lat = start[1] + state.progress * (end[1] - start[1]);

            state.progress += 0.005; // Adjust for animation speed

            if (state.progress >= 1) {
                state.progress = 0;
                state.routeIndex = nextIndex;

                // Reverse direction at the ends of the route
                if (state.routeIndex === 0 || state.routeIndex === route.length - 1) {
                    state.direction *= -1;
                }
            }

            return [lng, lat];
        };


        const THREE = window.THREE;

        // Create layers for each model
        routes.forEach((route, index) => {
            const customLayer = {
                id: `3d-model-${index}`,
                type: 'custom',
                renderingMode: '3d',
                onAdd: function (map, gl) {
                    this.camera = new THREE.Camera();
                    this.scene = new THREE.Scene();

                    const directionalLight = new THREE.DirectionalLight(0xffffff,4);
                    directionalLight.position.set(0, -90, 100).normalize();
                    this.scene.add(directionalLight);
                    

                    const loader = new THREE.GLTFLoader();
                    loader.load(
                        'img/carr.glb',
                        (gltf) => {
                            this.model = gltf.scene;
                            this.scene.add(this.model);
                            this.model.scale.set(2, 2, 2);
                        }
                    );

                    this.map = map;
                    this.renderer = new THREE.WebGLRenderer({
                        canvas: map.getCanvas(),
                        context: gl,
                        antialias: true
                    });

                    this.renderer.autoClear = false;
                },
                render: function (gl, matrix) {
                    if (!this.model) return;

                    const newPosition = updateModelPosition(states[index], route);
                    const mercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(newPosition, modelAltitude);

                    const rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1, 0, 0), modelRotate[0]);
                    const rotationY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 1, 0), modelRotate[1]);
                    const rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 0, 1), modelRotate[2]);

                    const m = new THREE.Matrix4().fromArray(matrix);
                    const l = new THREE.Matrix4()
                        .makeTranslation(mercatorCoordinate.x, mercatorCoordinate.y, mercatorCoordinate.z)
                        .scale(new THREE.Vector3(mercatorCoordinate.meterInMercatorCoordinateUnits(), -mercatorCoordinate.meterInMercatorCoordinateUnits(), mercatorCoordinate.meterInMercatorCoordinateUnits()))
                        .multiply(rotationX)
                        .multiply(rotationY)
                        .multiply(rotationZ);

                    this.camera.projectionMatrix = m.multiply(l);
                    this.renderer.resetState();
                    this.renderer.render(this.scene, this.camera);
                    this.map.triggerRepaint();
                }
            };

            map.on('style.load', () => {
                map.addLayer(customLayer, 'waterway-label');
            });
        });
        
        const nav = new mapboxgl.NavigationControl({ showCompass: true });
        map.addControl(nav, 'bottom-right');

       
        function changeView(zoom, pitch, bearing, lat, long) {
        map.flyTo({
            center: [long, lat],  // Pastikan posisi adalah [long, lat] karena Leaflet.js menggunakan urutan [lng, lat]
            zoom: zoom,
            pitch: pitch,         // Perhatikan bahwa Leaflet.js tidak mendukung pitch, jadi bisa diabaikan atau disesuaikan dengan peta lainnya (misalnya, Mapbox)
            bearing: bearing,     // Sama seperti pitch, Leaflet.js tidak memiliki dukungan langsung untuk bearing, kecuali menggunakan Mapbox
            duration: 2000         // Durasi animasi dalam milidetik
        });
        }

        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl
            }),
            'top-left'
        );

        map.addControl(
        new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            interactive: false
        }),
        'top-left' );

        
        map.addControl(new mapboxgl.FullscreenControl());
        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true,
                polyline: true,
            },
        });
        map.addControl(draw);
        map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');


        map.on('draw.create', updateMeasurements);
        map.on('draw.delete', updateMeasurements);
        map.on('draw.update', updateMeasurements);
        

        function updateMeasurements(e) {
            const data = draw.getAll();
            const answer = document.getElementById('calculated-area');
            if (data.features.length > 0) {
                // Calculate area in square meters
                const area = turf.area(data);
                const rounded_area = Math.round(area * 100) / 100;

                // Calculate perimeter in meters
                const perimeter = turf.length(data, { units: 'kilometers' }) * 1000;
                const rounded_perimeter = Math.round(perimeter * 100) / 100;

                // Display results
                answer.innerHTML = `
                    <p><strong>Area:</strong></p>
                    <p>${rounded_area} m<sup>2</sup></p>
                    <p><strong>Perimeter:</strong></p>
                    <p>${rounded_perimeter} m</p>
                `;
            } else {
                answer.innerHTML = '';
                if (e.type !== 'draw.delete')
                    alert('Click the map to draw a polygon.');
            }
        }
        const layerList = document.getElementById('menu');
        const inputs = layerList.getElementsByTagName('input');
    
        for (const input of inputs) {
            input.onclick = (layer) => {
                const layerId = layer.target.id;
                map.setStyle('mapbox://styles/mapbox/' + layerId);
            };
        }
        
        
        const modelOrigin = [110.374298,    -7.786487];


        const modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
            modelOrigin,
            modelAltitude
        );

        // transformation parameters to position, rotate and scale the 3D model onto the map
        const modelTransform = {
            translateX: modelAsMercatorCoordinate.x,
            translateY: modelAsMercatorCoordinate.y,
            translateZ: modelAsMercatorCoordinate.z,
            rotateX: modelRotate[0],
            rotateY: modelRotate[1],
            rotateZ: modelRotate[2],
            /* Since the 3D model is in real world meters, a scale transform needs to be
            * applied since the CustomLayerInterface expects units in MercatorCoordinates.
            */
            scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()
        };



        


        // configuration of the custom layer for a 3D model per the CustomLayerInterface
        const customLayer = {
            id: '3d-model',
            type: 'custom',
            renderingMode: '3d',
            onAdd: function (map, gl) {
                this.camera = new THREE.Camera();
                this.scene = new THREE.Scene();

                // create two three.js lights to illuminate the model
                const directionalLight = new THREE.DirectionalLight(0xffffff);
                directionalLight.position.set(0, -60, 60).normalize();
                this.scene.add(directionalLight);

                const directionalLight2 = new THREE.DirectionalLight(0xffffff);
                directionalLight2.position.set(0, 70, 60).normalize();
                this.scene.add(directionalLight2);

                this.map = map;

                // use the Mapbox GL JS map canvas for three.js
                this.renderer = new THREE.WebGLRenderer({
                    canvas: map.getCanvas(),
                    context: gl,
                    antialias: true
                });

                this.renderer.autoClear = false;
            },
            render: function (gl, matrix) {
                const rotationX = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(1, 0, 0),
                    modelTransform.rotateX
                );
                const rotationY = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 1, 0),
                    modelTransform.rotateY
                );
                const rotationZ = new THREE.Matrix4().makeRotationAxis(
                    new THREE.Vector3(0, 0, 1),
                    modelTransform.rotateZ
                );

                const m = new THREE.Matrix4().fromArray(matrix);
                const l = new THREE.Matrix4()
                    .makeTranslation(
                        modelTransform.translateX,
                        modelTransform.translateY,
                        modelTransform.translateZ
                    )
                    .scale(
                        new THREE.Vector3(
                            modelTransform.scale,
                            -modelTransform.scale,
                            modelTransform.scale
                        )
                    )
                    .multiply(rotationX)
                    .multiply(rotationY)
                    .multiply(rotationZ);

                this.camera.projectionMatrix = m.multiply(l);
                this.renderer.resetState();
                this.renderer.render(this.scene, this.camera);
                this.map.triggerRepaint();
            }
        };

        map.on('style.load', () => {
            map.addLayer(customLayer, 'waterway-label');
        });


        map.on('style.load', () => {
        // Memuat file GeoJSON bidang tanah
        fetch('./img/gabunganaja.geojson')
            .then(response => response.json())
            .then(geojson => {
                // Menambahkan sumber GeoJSON bidang tanah ke peta
                map.addSource('geojson-data-bidang', {
                    type: 'geojson',
                    data: geojson
                });

                // Menambahkan layer untuk bidang tanah (fill)
                map.addLayer({
                    id: 'geojson-layer-bidang',
                    type: 'fill', // Layer type is 'fill' for polygons
                    source: 'geojson-data-bidang',
                    paint: {
                        'fill-color': '#fdca40', // Default fill color (light yellow)
                        'fill-opacity': 0,
                    }
                });
                

                // Menambahkan layer untuk batas bidang tanah (line)
                map.addLayer({
                    id: 'geojson-boundary-bidang',
                    type: 'line', // Layer type is 'line' for boundaries
                    source: 'geojson-data-bidang',
                    paint: {
                        'line-color': '#f03b20', // Default boundary color (turquoise)
                        'line-width': 1.5,
                        'line-opacity': 1,
                    }
                });

        // Interaksi klik untuk bidang tanah
        map.on('click', 'geojson-layer-bidang', (e) => {
                const properties = e.features[0].properties; // Mengambil atribut bidang tanah
                const coordinates = e.lngLat; // Mengambil lokasi klik

                let tableContent = '<table style="width:100%; border-collapse:collapse;">';
                for (const [key, value] of Object.entries(properties)) {
                    tableContent += `
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;"><strong>${key}</strong></td>
                            <td style="border:1px solid #ddd; padding:8px;">${value}</td>
                        </tr>
                    `;
                }
                tableContent += '</table>';

                
                // Menampilkan popup
                new mapboxgl.Popup({
                    offset: [10, -10] // Offset horizontal dan vertikal untuk menghindari overlap
                })
                    .setLngLat([coordinates.lng + 0.00050, coordinates.lat + 0.00000])
                    .setHTML(`
                        <div style="font-family:Arial, sans-serif; font-size:10px;">
                            <strong>Atribut Bidang Tanah</strong><br>
                            ${tableContent}
                        </div>
                    `)
                    .addTo(map);
            });

        const rainLayer = new RainLayer({
            id: 'rain',
            source: 'rainviewer',
            scale: 'noaa'
            });
            map.addLayer(rainLayer);

            // You can get the HTML text for the legend
        const legendHTML = rainLayer.getLegendHTML();

            // You can receive radar data refresh events
            // data.timestamp - Unix timestamp in seconds (UTC) when the data was generated
            rainLayer.on('refresh', data => {
                console.log(data.timestamp);
            });
            rainLayer.setOpacity(1);
    

            // Menambahkan interaksi hover pada bidang tanah
        map.on('mouseenter', 'geojson-layer-bidang', (e) => {
                map.getCanvas().style.cursor = 'pointer';
                const featureId = e.features[0].properties.OBJECTID;

                map.setPaintProperty('geojson-layer-bidang', 'fill-color', [
                    'case',
                    ['==', ['get', 'OBJECTID'], featureId], '#d63230',
                    '#fdca40'
                ]);
                map.setPaintProperty('geojson-boundary-bidang', 'line-color', [
                    'case',
                    ['==', ['get', 'OBJECTID'], featureId], '#d63230',
                    '#40bcd8'
                ]);
            });

        map.on('mouseleave', 'geojson-layer-bidang', () => {
                map.getCanvas().style.cursor = '';
                map.setPaintProperty('geojson-layer-bidang', 'fill-color', '#fdca40');
                map.setPaintProperty('geojson-boundary-bidang', 'line-color', '#40bcd8');
            });
        })
        .catch(err => console.error('Gagal memuat GeoJSON Bidang Tanah:', err));
    });

    // Memuat file GeoJSON RDTR
    fetch('./img/RDTR.geojson')
            .then(response => response.json())
            .then(geojson => {
                // Menambahkan sumber GeoJSON RDTR ke peta
                map.addSource('geojson-data-RDTR', {
                    type: 'geojson',
                    data: geojson
                });

                // Menambahkan layer untuk bidang tanah (fill)
                map.addLayer({
                    id: 'geojson-layer-RDTR',
                    type: 'fill', // Layer type is 'fill' for polygons
                    source: 'geojson-data-RDTR',
                    paint: {
                        'fill-color': [
                        'match',
                        ['get', 'PenggunaanTR'], // Ambil atribut 'TataRuang'
                        1, '#99d8c9', // Light Pink untuk nilai 1
                        2, '#c994c7', // Lemon Chiffon untuk nilai 2
                        3, '#feb24c', // Pale Green untuk nilai 3
                        4, '#7fcdbb', // Light Blue untuk nilai 4
                        5, '#f0f99b', // Plum untuk nilai 5
                        6, '#fee6ce', // Peach Puff untuk nilai 6
                        7, '#8d7369', // Lavender untuk nilai 7
                        8, '#bdbdbd', // Khaki untuk nilai 8
                        9, '#9ecae1', // Misty Rose untuk nilai 9
                        '#CCCCCC' // Warna default (abu-abu)
                        ],
                        'fill-opacity': 0.6,
                    }
                });
                

                // Menambahkan layer untuk batas bidang tanah (line)
                map.addLayer({
                    id: 'geojson-boundary-RDTR',
                    type: 'line', // Layer type is 'line' for boundaries
                    source: 'geojson-data-RDTR',
                    paint: {
                        'line-color': '#40bcd8', // Default boundary color (turquoise)
                        'line-width': 0,
                        'line-opacity': 0,
                    }
                });

        // Interaksi klik untuk RDTR
        map.on('click', 'geojson-layer-RDTR', (e) => {
                const properties = e.features[0].properties; // Mengambil atribut bidang tanah
                const coordinates = e.lngLat; // Mengambil lokasi klik

                let tableContent = '<table style="width:100%; border-collapse:collapse;">';
                for (const [key, value] of Object.entries(properties)) {
                    tableContent += `
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;"><strong>${key}</strong></td>
                            <td style="border:1px solid #ddd; padding:8px;">${value}</td>
                        </tr>
                    `;
                }
                tableContent += '</table>';

                new mapboxgl.Popup({
                    offset: [10, -10] // Offset horizontal dan vertikal untuk menghindari overlap
                })
                    .setLngLat([coordinates.lng - 0.00050, coordinates.lat + 0.00000])
                    .setHTML(`
                        <div style="font-family:Arial, sans-serif; font-size:10px;">
                            <strong>Atribut RDTR</strong><br>
                            ${tableContent}
                        </div>
                    `)
                    .addTo(map);
            });
            
        // Memastikan layer tetap tampil setelah perubahan basemap
        map.on('style.load', () => {
            if (!map.getSource('geojson-data-RDTR')) {
                map.addSource('geojson-data-RDTR', {
                    type: 'geojson',
                    data: geojson
                });

                map.addLayer({
                    id: 'geojson-layer-RDTR',
                    type: 'fill', // Layer type is 'fill' for polygons
                    source: 'geojson-data-RDTR',
                    paint: {
                        'fill-color': [
                        'match',
                        ['get', 'PenggunaanTR'], // Ambil atribut 'TataRuang'
                        1, '#99d8c9', // Light Pink untuk nilai 1
                        2, '#c994c7', // Lemon Chiffon untuk nilai 2
                        3, '#feb24c', // Pale Green untuk nilai 3
                        4, '#7fcdbb', // Light Blue untuk nilai 4
                        5, '#f0f99b', // Plum untuk nilai 5
                        6, '#fee6ce', // Peach Puff untuk nilai 6
                        7, '#8d7369', // Lavender untuk nilai 7
                        8, '#bdbdbd', // Khaki untuk nilai 8
                        9, '#9ecae1', // Misty Rose untuk nilai 9
                        '#CCCCCC' // Warna default (abu-abu)
                        ],
                        'fill-opacity': 0.6,
                    }
                });

            }
        });
        const rainLayer = new RainLayer({
            id: 'rain',
            source: 'rainviewer',
            scale: 'noaa'
            });
            map.addLayer(rainLayer);

            // You can get the HTML text for the legend
        const legendHTML = rainLayer.getLegendHTML();

            // You can receive radar data refresh events
            // data.timestamp - Unix timestamp in seconds (UTC) when the data was generated
            rainLayer.on('refresh', data => {
                console.log(data.timestamp);
            });
            rainLayer.setOpacity(1);
    

            // Menambahkan interaksi hover pada RDTR
        map.on('mouseenter', 'geojson-layer-RDTR', (e) => {
                map.getCanvas().style.cursor = 'pointer';
                const featureId = e.features[0].properties.OBJECTID;

                map.setPaintProperty('geojson-layer-RDTR', 'fill-color', [
                    'case',
                    ['==', ['get', 'fid'], featureId], '#d63230',
                    '#fdca40'
                ]);
                map.setPaintProperty('geojson-boundary-RDTR', 'line-color', [
                    'case',
                    ['==', ['get', 'fid'], featureId], '#d63230',
                    '#40bcd8'
                ]);
            });

        map.on('mouseleave', 'geojson-layer-RDTR', () => {
                map.getCanvas().style.cursor = '';
                map.setPaintProperty('geojson-layer-RDTR', 'fill-color', '#fdca40');
                map.setPaintProperty('geojson-boundary-RDTR', 'line-color', '#40bcd8');
            });
        })
        .catch(err => console.error('Gagal memuat GeoJSON Bidang Tanah:', err));

    // Memuat file GeoJSON bangunan
    fetch('./img/Bangunanbenar.geojson')
    .then(response => response.json())
    .then(geojson => {
        // Menambahkan sumber GeoJSON bangunan ke peta
        map.addSource('geojson-data-bangunan', {
            type: 'geojson',
            data: geojson
        });

        // Menambahkan layer untuk bangunan ekstrusi (LOD2)
        map.addLayer({
            id: 'building-extrusion',
            type: 'fill-extrusion', // Layer type is 'fill-extrusion' for 3D buildings
            source: 'geojson-data-bangunan',
            paint: {
                'fill-extrusion-color': [
                    'match',
                    ['get', 'Penggunaan'], // Ambil atribut 'use_bgn'
                    1, '#e30f0f', // Soft Red untuk nilai 1
                    2, '#e5e519', // Soft Yellow untuk nilai 2
                    3, '#19d519', // Soft Green untuk nilai 3
                    4, '#17b6e6', // Soft Blue untuk nilai 4
                    5, '#d543d5', // Soft Purple untuk nilai 5
                    6, '#d543d5', // Soft Purple untuk nilai 6
                    '#E0E0E0' // Soft Gray untuk warna default

                ],
                'fill-extrusion-height': ['get', 'Tinggi (m)'], // Tinggi bangunan
                'fill-extrusion-base': 0,
                'fill-extrusion-opacity': 1
            }
        });
        map.moveLayer('geojson-layer-bidang',  'building-extrusion','geojson-layer-RDTR', 'rain');
        


        // Interaksi klik untuk bangunan
        map.on('click', 'building-extrusion', (e) => {
            const properties = e.features[0].properties; // Mengambil atribut bangunan
            const coordinates = e.lngLat;

            let tableContent = '<table style="width:100%; border-collapse:collapse;">';
            for (const [key, value] of Object.entries(properties)) {
                tableContent += `
                    <tr>
                        <td style="border:1px solid #ddd; padding:8px;"><strong>${key}</strong></td>
                        <td style="border:1px solid #ddd; padding:8px;">${value}</td>
                    </tr>
                `;
            }
            tableContent += '</table>';

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(`
                    <div style="font-family:Arial, sans-serif; font-size:10px;">
                        <strong>Atribut Bangunan</strong><br>
                        ${tableContent}
                    </div>
                `)
                .addTo(map);
        });

        map.setPaintProperty('building-extrusion', 'fill-extrusion-color', [
            'match',
            ['get', 'Penggunaan'], // Ambil nilai atribut 'use_bgn'
            1, '#e30f0f', // Soft Red untuk nilai 1
            2, '#e5e519', // Soft Yellow untuk nilai 2
            3, '#19d519', // Soft Green untuk nilai 3
            4, '#17b6e6', // Soft Blue untuk nilai 4
            5, '#d543d5', // Soft Purple untuk nilai 5
            6, '#d543d5', // Soft Purple untuk nilai 6
            '#E0E0E0' // Soft Gray untuk warna default

        ]);


        // Memastikan layer tetap tampil setelah perubahan basemap
        map.on('style.load', () => {
            if (!map.getSource('geojson-data-bangunan')) {
                map.addSource('geojson-data-bangunan', {
                    type: 'geojson',
                    data: geojson
                });

                map.addLayer({
                    id: 'building-extrusion',
                    type: 'fill-extrusion',
                    source: 'geojson-data-bangunan',
                    paint: {
                        'fill-extrusion-color': [
                            'match',
                            ['get', 'Penggunaan'], // Ambil atribut 'use_bgn'
                            1, '#e30f0f', // Soft Red untuk nilai 1
                            2, '#e5e519', // Soft Yellow untuk nilai 2
                            3, '#19d519', // Soft Green untuk nilai 3
                            4, '#17b6e6', // Soft Blue untuk nilai 4
                            5, '#d543d5', // Soft Purple untuk nilai 5
                            6, '#d543d5', // Soft Purple untuk nilai 6
                            '#E0E0E0' // Soft Gray untuk warna default
                        ],
                        'fill-extrusion-height': ['get', 'Tinggi (m)'], // Tinggi bangunan
                        'fill-extrusion-base': 0,
                        'fill-extrusion-opacity': 1
                    }
                });

            }
        });

    })
    .catch(err => console.error('Gagal memuat GeoJSON Bangunan:', err));



        map.on('style.load', () => {
        Papa.parse('./img/cctvbaru.csv', {
            download: true,
            header: true,
            complete: function (results) {
                console.log("Data CCTV dari CSV berhasil dimuat:", results.data); // Debugging output
                addCCTVMarkers(results.data);
            },
            error: function (err) {
                console.error("Gagal memuat CSV:", err);
            }
        });

        function addCCTVMarkers(data) {
            if (!data || data.length === 0) {
                console.error("Data CCTV kosong atau tidak valid.");
                return;
            }

            data.forEach((cctv, index) => {
                if (!cctv.long || !cctv.lat || !cctv.link) {
                    console.warn("Data CCTV tidak lengkap:", cctv);
                    return;
                }

                console.log("Menambahkan marker untuk CCTV:", cctv);

                // Buat elemen custom marker
                const el = document.createElement('div');
                el.className = 'custom-marker';
                el.style.backgroundImage = 'url(img/cctv.png)';
                el.style.width = '30px';
                el.style.height = '30px';
                el.style.backgroundSize = '100%';

                // Buat ID unik untuk video pada popup
                const videoId = `video-popup-${index}`;

                // Buat popup
                const popup = new mapboxgl.Popup().setHTML(`
                <div style="width: 200px; height: 180px; padding: 5px;">
                    <div style="text-align: center; font-weight: bold; margin-bottom: 10px;"> ${cctv.Name}
                    </div>
                    <video id="${videoId}" style="width: 100%; height: 150px;" controls></video>
                </div>
                `);

                // Tambahkan marker ke peta
                new mapboxgl.Marker(el)
                    .setLngLat([parseFloat(cctv.long), parseFloat(cctv.lat)]) // Konversi koordinat ke float
                    .setPopup(popup)
                    .addTo(map);

                // Event untuk memutar video saat popup dibuka
                popup.on('open', () => {
                    const video = document.getElementById(videoId);
                    if (!video) {
                        console.error('Video element tidak ditemukan:', videoId);
                        return;
                    }

                    // Menggunakan HLS.js jika didukung
                    if (Hls.isSupported()) {
                        console.log('HLS.js didukung untuk video:', cctv.link);

                        const hls = new Hls();
                        hls.loadSource(cctv.link); // URL stream HLS
                        hls.attachMedia(video);

                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            console.log('HLS manifest parsed untuk video:', cctv.link);
                            video.play();
                        });

                        hls.on(Hls.Events.ERROR, (event, data) => {
                            console.error('Error HLS.js untuk video:', cctv.link, data);
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        console.log('Browser mendukung HLS natively untuk video:', cctv.link);

                        video.src = cctv.link; // URL stream HLS
                        video.addEventListener('loadedmetadata', () => {
                            video.play();
                        });
                    } else {
                        console.error('Browser tidak mendukung HLS untuk video:', cctv.link);
                    }
                });
            });
        }


        const trackButton = document.getElementById('track-button');
            let watchId = null; // Variabel untuk menyimpan ID pelacakan lokasi
            let userMarker = null; // Variabel untuk menyimpan marker pengguna

            // Fungsi untuk memperbarui center peta dan menambahkan marker berdasarkan koordinat terbaru
            function updateMapCenter(position) {
                const lng = position.coords.longitude;
                const lat = position.coords.latitude;

                // Pusatkan peta di lokasi pengguna
                map.flyTo({
                    center: [lng, lat],
                    essential: true,
                    zoom: 15
                });

                // Tambahkan atau perbarui marker lokasi pengguna
                if (userMarker) {
                    // Jika marker sudah ada, perbarui posisinya
                    userMarker.setLngLat([lng, lat]);
                } else {
                    // Jika marker belum ada, buat marker baru
                    userMarker = new mapboxgl.Marker({
                        color: '#ff0000', // Warna cerah (merah terang)
                        draggable: false, // Marker tidak bisa digeser
                    })
                        .setLngLat([lng, lat]) // Set lokasi marker
                        .addTo(map); // Tambahkan ke peta
                }
            }

            // Fungsi untuk memulai atau menghentikan pelacakan lokasi
            function toggleTracking() {
                if (watchId === null) {
                    // Mulai pelacakan
                    if ("geolocation" in navigator) {
                        watchId = navigator.geolocation.watchPosition(updateMapCenter, (error) => {
                            console.error('Error accessing geolocation: ', error);
                        }, {
                            enableHighAccuracy: true,
                            maximumAge: 1000,
                            timeout: 10000
                        });

                        trackButton.innerText = 'Stop';
                        trackButton.classList.add('active');
                    } else {
                        alert("Geolocation tidak didukung di browser ini.");
                    }
                } else {
                    // Hentikan pelacakan
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                    trackButton.innerText = 'Geolocation';
                    trackButton.classList.remove('active');

                    // Hapus marker lokasi pengguna
                    if (userMarker) {
                        userMarker.remove(); // Hapus marker dari peta
                        userMarker = null; // Set marker kembali ke null
                    }
                }
            }

            // Event listener untuk tombol pelacakan
            trackButton.addEventListener('click', toggleTracking);


        
        function updateClock() {
            const now = new Date();
            const day = now.toLocaleDateString('en-US', { weekday: 'short' });
            const date = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            document.getElementById('clock').innerHTML = `${day}, ${date}<br>${time}`;
        }

        // Memperbarui waktu setiap detik
        setInterval(updateClock, 1000);
        updateClock();

        

        map.on('load', function() {
            const script = document.createElement('script');
            script.src = 'node_modules/@mapbox-controls/ruler';
            script.onload = function() {
                // Inisialisasi RulerControl dan tambahkan ke elemen khusus
                const rulerControl = new RulerControl();
                map.addControl(rulerControl); // Pastikan kontrol diaktifkan pada peta

                // Pindahkan elemen kontrol ke dalam kontainer khusus
                const controlElement = document.querySelector('.mapboxgl-ctrl-ruler');
                const rulerContainer = document.getElementById('rulerControlContainer');
                rulerContainer.appendChild(controlElement);
            };
            document.body.appendChild(script);
        });

        

        const transactions = [
            { name: "12/1/2024, 12:10:43 AM", value: "TRANSACTION" },
            { name: "12/1/2024, 12:12:00 AM", value: "TRANSACTION" }
        ];
        function populateHistory() {
        const historyContent = document.getElementById("history-content");
        historyContent.innerHTML = "";  // Kosongkan history yang lama

        transactions.forEach((transaction) => {
            const li = document.createElement("li");
            li.textContent = `${transaction.name}: ${transaction.value}`;
            li.addEventListener("click", () => showModal(transaction));  // Tampilkan modal saat klik
            historyContent.appendChild(li);
        });
          }

        // Dummy data detail transaksi
        const transactionDetails = {
            1: [
                { info: "NIB", old: "123456789", new: "987654321" },
                { info: "Jenis Hak", old: "Hak Milik", new: "Hak Pakai" },
                { info: "Penggunaan", old: "Perumahan", new: "Komersial" },
                { info: "Luas", old: "200 m2", new: "250 m2" },
                { info: "Pemilik", old: "John Doe", new: "Jane Smith" },
                { info: "Kecamatan", old: "Kec. Lama", new: "Kec. Baru" },
                { info: "Kelurahan", old: "Kel. Lama", new: "Kel. Baru" }
            ],
            2: [
                { info: "NIB", old: "111222333", new: "333222111" },
                { info: "Jenis Hak", old: "Hak Guna Bangunan", new: "Hak Milik" },
                { info: "Penggunaan", old: "Industri", new: "Pertanian" },
                { info: "Luas", old: "300 m2", new: "400 m2" },
                { info: "Pemilik", old: "Alice Brown", new: "Bob White" },
                { info: "Kecamatan", old: "Kec. Tengah", new: "Kec. Utara" },
                { info: "Kelurahan", old: "Kel. Lama", new: "Kel. Baru" }
            ]
        };

        // Dummy data lokasi berdasarkan NIB
        // Fungsi untuk menampilkan modal dengan detail transaksi
        function showModal(transaction) {
            const modal = document.getElementById("modal");
            const tableBody = document.querySelector("#transaction-table tbody");
            tableBody.innerHTML = ""; // Kosongkan tabel sebelumnya

            // Pilih dummy data berdasarkan transaksi
            const details = transactionDetails[transactions.findIndex(t => t.name === transaction.name) + 1];
            
            // Tentukan koordinat lat lng langsung (tanpa perlu mengambil dari locationData)
            let selectedLatLng = { lat: -7.785448, lng: 110.372014 };  // Contoh koordinat (ubah sesuai kebutuhan)

            // Generate baris tabel
            details.forEach(row => {
                if (row.info === "NIB") {
                    // Anda bisa memodifikasi kode ini untuk mengambil NIB jika perlu
                    // Misalnya jika ingin mengubah koordinat berdasarkan NIB, ubah selectedLatLng
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.info}</td>
                    <td>${row.old}</td>
                    <td>${row.new}</td>
                `;
                tableBody.appendChild(tr);
            });


            modal.style.display = "flex"; // Tampilkan modal
        }

        // Event Listener untuk menutup modal
        document.getElementById("close-modal").addEventListener("click", () => {
            document.getElementById("modal").style.display = "none";
        });


        // Fungsi untuk menampilkan dropdown ketika tombol ditekan
        document.getElementById("history-btn").addEventListener("click", function(event) {
            event.stopPropagation();
            const dropdown = document.getElementById("history-content");
            populateHistory();
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        });

        // Menutup dropdown ketika klik di luar dropdown
        window.addEventListener("click", function(event) {
            if (!event.target.matches("#history-btn")) {
                document.getElementById("history-content").style.display = "none";
            }
        // Menutup dropdown ketika klik di luar dropdown
        window.addEventListener("click", function(event) {
            if (!event.target.matches("fly-to-location")) {
                document.getElementById("modal").style.display = "none";
            }
});
});

    });
    
    </script>



    <!-- Back to Top -->


    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const navbar = document.querySelector('.navbar');
            const map = document.getElementById('map');

            const adjustMapPosition = () => {
                const navbarHeight = navbar ? navbar.offsetHeight : 0;
                map.style.top = `${navbarHeight}px`;
            };

            window.addEventListener('resize', adjustMapPosition);
            adjustMapPosition();
        });
    </script>
</body>

</html>